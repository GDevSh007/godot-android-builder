name: ðŸ¤– Android Universal Template (Godot 4.5.1)
on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-24.04
    name: Android Universal Template (Arm64 + Arm32)
    timeout-minutes: 120 # Increased timeout for double compilation
    
    defaults:
      run:
        working-directory: godot-source

    steps:
      # 1. Checkout YOUR repo (where ludmax.gdbuild lives)
      - name: Checkout Configs
        uses: actions/checkout@v4
        with:
          path: config-repo

      # 2. Checkout Godot Source
      - name: Checkout Godot Source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: 4.5.1-stable
          path: godot-source

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install SCons
        run: python -m pip install scons

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # CRITICAL FIX: Install the specific NDK version for Godot 4
      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;23.2.8568313" --channel=3
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/23.2.8568313" >> $GITHUB_ENV

      - name: Install 7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Download and Extract Swappy
        run: |
          TAG="from-source-2025-01-31"
          ASSET_NAME="godot-swappy.7z"
          curl -L -o godot-swappy.7z https://github.com/godotengine/godot-swappy/releases/download/$TAG/$ASSET_NAME
          mkdir -p thirdparty/swappy-frame-pacing
          7z x godot-swappy.7z -othirdparty/swappy-frame-pacing -y
          cd thirdparty/swappy-frame-pacing
          # Safety check: move contents if nested in a folder named android.*
          mv android.*/* . 2>/dev/null || true
          cd ../..
          rm -f godot-swappy.7z

      # 3. Compilation (Compiling BOTH Architectures)
      
      # --- ARM64 Builds ---
      - name: Compilation Debug (Arm64)
        run: |
          scons platform=android \
          target=template_debug \
          arch=arm64 \
          build_profile=$GITHUB_WORKSPACE/config-repo/ludmax.gdbuild \
          dev_mode=yes \
          module_text_server_fb_enabled=yes \
          tests=no \
          swappy=yes

      - name: Compilation Release (Arm64)
        run: |
          scons platform=android \
          target=template_release \
          arch=arm64 \
          build_profile=$GITHUB_WORKSPACE/config-repo/ludmax.gdbuild \
          dev_mode=no \
          module_text_server_fb_enabled=yes \
          tests=no \
          swappy=yes

      # --- ARM32 Builds ---
      - name: Compilation Debug (Arm32)
        run: |
          scons platform=android \
          target=template_debug \
          arch=arm32 \
          build_profile=$GITHUB_WORKSPACE/config-repo/ludmax.gdbuild \
          dev_mode=yes \
          module_text_server_fb_enabled=yes \
          tests=no \
          swappy=yes

      - name: Compilation Release (Arm32)
        run: |
          scons platform=android \
          target=template_release \
          arch=arm32 \
          build_profile=$GITHUB_WORKSPACE/config-repo/ludmax.gdbuild \
          dev_mode=no \
          module_text_server_fb_enabled=yes \
          tests=no \
          swappy=yes

      # 4. Generate Templates & Bundle AARs
      - name: Generate Godot Templates
        run: |
          cd platform/android/java
          ./gradlew generateGodotTemplates
          
          # Copy the hidden .aar files to the bin folder so they are uploaded
          echo "Copying AAR files..."
          cp lib/build/outputs/aar/*.aar ../../../bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-template-4.5.1-universal
          path: godot-source/bin/
