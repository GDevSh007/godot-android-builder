name: ðŸ¤– Android Arm64 Template (Godot 4.5.1)
on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-24.04
    name: Android Arm64 Template
    timeout-minutes: 90
    steps:
      # 1. Checkout YOUR repo (to get ludmax.gdbuild)
      - name: Checkout Configs
        uses: actions/checkout@v4
        with:
          path: config-repo

      # 2. Checkout Godot Source at 4.5.1-stable
      - name: Checkout Godot Source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: 4.5.1-stable
          path: godot-source

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install SCons
        run: python -m pip install scons

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 3. Official GitHub Cache (Speeds up future builds)
      - name: SCons Cache
        uses: actions/cache@v4
        with:
          path: godot-source/.scons_cache
          key: android-arm64-godot-4.5.1-${{ github.ref }}
          restore-keys: |
            android-arm64-godot-4.5.1-

      # 4. Run the Swappy script
      - name: Download Swappy
        run: |
          cd godot-source
          python ./misc/scripts/install_swappy_android.py

      # 5. Compilation
      - name: Compilation
        run: |
          cd godot-source
          scons platform=android \
                target=template_debug \
                arch=arm64 \
                build_profile=../config-repo/.github/workflows/ludmax.gdbuild \
                use_static_cpp=yes \
                dev_mode=yes \
                module_text_server_fb_enabled=yes \
                tests=no \
                swappy=yes \
                scons_cache=.scons_cache

      # 6. Package the APKs
      - name: Generate Godot templates
        run: |
          cd godot-source/platform/android/java
          ./gradlew generateGodotTemplates

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-template-4.5.1-arm64
          path: godot-source/bin/
