name: ðŸ¤– Android Arm64 Template (Godot 4.5.1)
on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-24.04
    name: Android Arm64 Template
    timeout-minutes: 90
    
    defaults:
      run:
        working-directory: godot-source

    steps:
      - name: Checkout Configs
        uses: actions/checkout@v4
        with:
          path: config-repo

      - name: Checkout Godot Source
        uses: actions/checkout@v4
        with:
          repository: godotengine/godot
          ref: 4.5.1-stable
          path: godot-source

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install SCons
        run: python -m pip install scons

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install 7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Download and Extract Swappy
        run: |
          # Pin to the known working release as of January 2026
          TAG="from-source-2025-01-31"
          ASSET_NAME="gamesdk.zip"  # Current asset name in recent releases
          
          echo "Downloading Swappy from tag: $TAG"
          curl -L -o swappy.zip \
            https://github.com/godotengine/godot-swappy/releases/download/$TAG/$ASSET_NAME
          
          # Extract the required swappy_static folder
          mkdir -p thirdparty/swappy-frame-pacing
          7z x swappy.zip "games-frame-pacing-release.aar_FILES/prefab/modules/swappy_static/*" -o temp_swappy -y
          mv temp_swappy/games-frame-pacing-release.aar_FILES/prefab/modules/swappy_static/* thirdparty/swappy-frame-pacing/
          rm -rf temp_swappy swappy.zip
          
          # Godot expects specific folder names inside thirdparty/swappy-frame-pacing
          # (arm64-v8a, armeabi-v7a, x86_64, etc.)
          # Recent prebuilts use "android.arm64-v8a" etc. with "android." prefix â€“ rename if needed
          cd thirdparty/swappy-frame-pacing
          for dir in android.*; do
            if [ -d "$dir" ]; then
              newname=$(echo $dir | sed 's/^android\.//')
              mv "$dir" "$newname"
            fi
          done

      - name: Compilation Debug
        run: |
          scons platform=android \
                target=template_debug \
                arch=arm64 \
                build_profile=../config-repo/.github/workflows/ludmax.gdbuild \
                dev_mode=yes \
                module_text_server_fb_enabled=yes \
                tests=no \
                swappy=yes

      - name: Compilation Release
        run: |
          scons platform=android \
                target=template_release \
                arch=arm64 \
                build_profile=../config-repo/.github/workflows/ludmax.gdbuild \
                dev_mode=yes \
                module_text_server_fb_enabled=yes \
                tests=no \
                swappy=yes

      - name: Generate Godot Templates
        run: |
          cd platform/android/java
          ./gradlew generateGodotTemplates

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-template-4.5.1-arm64
          path: godot-source/bin/
